<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T42U3">RESIDUAL</span> =  transformationResiduals(<span class="var type1" id="S3T1U6">MATRIXELEMENTS</span>, <span class="var type1" id="S4T16U7">IMAGE1</span>, <span class="var type1" id="S5T16U8">IMAGE2</span>, <span class="var type1" id="S6T16U9">SPATIALWINDOW</span>, <span class="var type1" id="S7T16U10">XGRID</span>, <span class="var type1" id="S8T16U11">YGRID</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% transformationResiduals(IMAGE1, MATRIXELEMENTS) calculates the residual intensity between images </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% INPUTS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">%   IMAGE1 = The original first image that is to be transformed (before windowing)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo" id="T2:U8"><span class="var type1" id="S9T2U14">s</span> = <span class="mxinfo" id="T2:U10"><span class="var type1" id="S3T1U16">MATRIXELEMENTS</span>(<span class="mxinfo" id="T2:U12">1</span>)</span></span>; <span class="comment">% X-scaling</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo" id="T2:U13"><span class="var type1" id="S10T2U20">th</span> = <span class="mxinfo" id="T2:U15"><span class="var type1" id="S3T1U22">MATRIXELEMENTS</span>(<span class="mxinfo" id="T2:U17">2</span>)</span></span>; <span class="comment">% Rotation angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo" id="T2:U18"><span class="var type1" id="S11T2U26">ux</span> = <span class="mxinfo" id="T2:U20"><span class="var type1" id="S3T1U28">MATRIXELEMENTS</span>(<span class="mxinfo" id="T2:U22">3</span>)</span></span>; <span class="comment">% X-shearing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo" id="T2:U23"><span class="var type1" id="S12T2U32">uy</span> = <span class="mxinfo" id="T2:U25"><span class="var type1" id="S3T1U34">MATRIXELEMENTS</span>(<span class="mxinfo" id="T2:U27">4</span>)</span></span>; <span class="comment">% Y-shearing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo" id="T2:U28"><span class="var type1" id="S13T2U38">tx</span> = <span class="mxinfo" id="T2:U30"><span class="var type1" id="S3T1U40">MATRIXELEMENTS</span>(<span class="mxinfo" id="T2:U32">5</span>)</span></span>; <span class="comment">% X-translation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo" id="T2:U33"><span class="var type1" id="S14T2U44">ty</span> = <span class="mxinfo" id="T2:U35"><span class="var type1" id="S3T1U46">MATRIXELEMENTS</span>(<span class="mxinfo" id="T2:U37">6</span>)</span></span>; <span class="comment">% Y-translation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"><span class="comment">% % Matrix elements</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"><span class="comment">% Isotropic scaling matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="mxinfo" id="T3:U38"><span class="var type1" id="S15T3U50">SCALING</span> = <span class="mxinfo" id="T3:U40">[<span class="mxinfo" id="T43:U41"><span class="var type1" id="S9T2U53">s</span> <span class="mxinfo" id="T2:U43">0</span> <span class="mxinfo" id="T2:U44">0</span></span>; <span class="mxinfo" id="T43:U45"><span class="mxinfo" id="T2:U46">0</span> <span class="var type1" id="S9T2U58">s</span> <span class="mxinfo" id="T2:U48">0</span></span>; <span class="mxinfo" id="T43:U49"><span class="mxinfo" id="T2:U50">0</span> <span class="mxinfo" id="T2:U51">0</span> <span class="mxinfo" id="T2:U52">1</span></span>]</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"><span class="comment">% Rotation matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo" id="T3:U53"><span class="var type1" id="S16T3U66">ROTATION</span> = <span class="mxinfo" id="T3:U55">[<span class="mxinfo" id="T43:U56"><span class="mxinfo" id="T2:U57">cos(<span class="var type1" id="S10T2U71">th</span>)</span> <span class="mxinfo" id="T2:U59">-<span class="mxinfo" id="T2:U60">sin(<span class="var type1" id="S10T2U75">th</span>)</span></span> <span class="mxinfo" id="T2:U62">0</span></span>; <span class="mxinfo" id="T43:U63"><span class="mxinfo" id="T2:U64">sin(<span class="var type1" id="S10T2U80">th</span>)</span> <span class="mxinfo" id="T2:U66">cos(<span class="var type1" id="S10T2U83">th</span>)</span> <span class="mxinfo" id="T2:U68">0</span></span>; <span class="mxinfo" id="T43:U69"><span class="mxinfo" id="T2:U70">0</span> <span class="mxinfo" id="T2:U71">0</span> <span class="mxinfo" id="T2:U72">1</span></span>]</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"><span class="comment">% Shearing matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo" id="T3:U73"><span class="var type1" id="S19T3U91">SHEARING</span> = <span class="mxinfo" id="T3:U75">[<span class="mxinfo" id="T43:U76"><span class="mxinfo" id="T2:U77">1</span> <span class="var type1" id="S11T2U95">ux</span> <span class="mxinfo" id="T2:U79">0</span></span>; <span class="mxinfo" id="T43:U80"><span class="var type1" id="S12T2U98">uy</span> <span class="mxinfo" id="T2:U82">1</span> <span class="mxinfo" id="T2:U83">0</span></span>; <span class="mxinfo" id="T43:U84"><span class="mxinfo" id="T2:U85">0</span> <span class="mxinfo" id="T2:U86">0</span> <span class="mxinfo" id="T2:U87">1</span></span>]</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"><span class="comment">% Translation matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"><span class="mxinfo" id="T3:U88"><span class="var type1" id="S20T3U107">TRANSLATION</span> = <span class="mxinfo" id="T3:U90">[<span class="mxinfo" id="T43:U91"><span class="mxinfo" id="T2:U92">1</span> <span class="mxinfo" id="T2:U93">0</span> <span class="var type1" id="S13T2U112">tx</span></span>; <span class="mxinfo" id="T43:U95"><span class="mxinfo" id="T2:U96">0</span> <span class="mxinfo" id="T2:U97">1</span> <span class="var type1" id="S14T2U116">ty</span></span>; <span class="mxinfo" id="T43:U99"><span class="mxinfo" id="T2:U100">0</span> <span class="mxinfo" id="T2:U101">0</span> <span class="mxinfo" id="T2:U102">1</span></span>]</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"><span class="comment">% Affine transformation matrix </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line"><span class="mxinfo" id="T3:U103"><span class="var type1" id="S21T3U123">A</span> = ( <span class="mxinfo" id="T3:U105"><span class="mxinfo" id="T3:U106"><span class="mxinfo" id="T3:U107"><span class="var type1" id="S20T3U128">TRANSLATION</span> * <span class="var type1" id="S15T3U129">SCALING</span></span> * <span class="var type1" id="S16T3U130">ROTATION</span></span> * <span class="var type1" id="S19T3U131">SHEARING</span></span> )</span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line"><span class="comment">% These are the vertical and horizontal coordinates of the inverse transformation. These</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line"><span class="comment">% are the non-integer image coordinates whose (interpolated) image values will</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line"><span class="comment">% make up the integer image coordinates in the output image.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line"><span class="mxinfo" id="T16:U112">[<span class="var type1" id="S22T16U135">yInv</span>, <span class="var type1" id="S23T16U136">xInv</span>] = <span class="fcn" id="F96N6:B138">transformImageCoordinates</span>(<span class="mxinfo" id="T3:U115">inv(<span class="var type1" id="S21T3U141">A</span>)</span>, <span class="var type1" id="S7T16U142">XGRID</span>, <span class="var type1" id="S8T16U143">YGRID</span>, <span class="string">'full'</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line"><span class="mxinfo" id="T16:U119"><span class="var type1" id="S26T16U147">transformedFirstImage</span> = <span class="mxinfo" id="T16:U121"><span class="var type1" id="S6T16U149">SPATIALWINDOW</span> .* <span class="mxinfo" id="T16:U123">interp2(<span class="var type1" id="S7T16U152">XGRID</span>, <span class="var type1" id="S8T16U153">YGRID</span>, <span class="var type1" id="S4T16U154">IMAGE1</span>, <span class="var type1" id="S23T16U155">xInv</span>, <span class="var type1" id="S22T16U156">yInv</span>, <span class="string">'linear'</span>, 0)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line"><span class="comment">% Calculate residuals</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line"><span class="mxinfo" id="T42:U129"><span class="var type1" id="S2T42U161">RESIDUAL</span> = <span class="mxinfo" id="T42:U131"><span class="mxinfo" id="T42:U132"><span class="var type1" id="S26T16U164">transformedFirstImage</span>(:)</span> - <span class="mxinfo" id="T42:U134"><span class="var type1" id="S5T16U167">IMAGE2</span>(:)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line"></span></span>
</pre>
